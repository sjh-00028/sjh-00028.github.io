<!DOCTYPE HTML>

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <script>
            var words;

            window.addEventListener("load", async () => {
                const wordsUrl = "https://sjh-00028.github.io/words.json";
                const wordsCache = await caches.open("words-cache");

                wordsCache.add(wordsUrl);

                let response = await wordsCache.match(wordsUrl);
                words = await response.json();

                if (window.location.search !== "") {
                    let params = new URLSearchParams(window.location.search);
                    let searchingWord = params.get("word");

                    if (searchingWord != null)
                        showWord(searchingWord);
                }
            });

            function showWord(word) {
                let wordEntries = words[word];

                while (wordEntries != null && wordEntries.length === 1 && typeof(wordEntries[0]) === "string") { // Alias
                    word = wordEntries[0];
                    wordEntries = words[word];
                }

                if (wordEntries == null) {
                    let errorElement = document.getElementById("error");

                    error.innerHTML = "'" + word + "' not found";
                    error.style.display = "unset";
                    return;
                }

                let infoElement = document.getElementById("wordInfo");
                for (var entry of wordEntries) {
                    infoElement.appendChild(constructWordView(word, entry));
                }
            }

            function constructWordView(wordName, wordInfo) {
                let wordDiv = document.createElement("div");
                wordDiv.className = "wordEntry";

                let wordHeader = document.createElement("h1");
                wordHeader.innerText = wordName;
                wordDiv.appendChild(wordHeader);
                
                if (typeof(wordInfo) === "string") { // Link to another word
                    let link = document.createElement("a");
                    
                    link.href = "?word=" + wordInfo;
                    link.innerText = "Form of " + wordInfo;
                    wordDiv.appendChild(link);
                    return wordDiv;
                }
                
                let definitionsList = document.createElement("ul");
                wordDiv.appendChild(definitionsList);
                for (const def of wordInfo.Definitions) {
                    let listItem = document.createElement("li");

                    listItem.innerHTML = def;
                    definitionsList.appendChild(listItem);
                }

                if (wordInfo.Forms !== undefined) {
                    let otherFormsHeader = document.createElement("h3");
                    let formsList = document.createElement("ul");

                    otherFormsHeader.innerText = "Other forms";
                    wordDiv.appendChild(otherFormsHeader);

                    wordDiv.appendChild(formsList);
                    for (const form of wordInfo.Forms) {
                        let listItem = document.createElement("li");

                        listItem.innerHTML = form;
                        formsList.appendChild(listItem);
                    }
                }

                return wordDiv;
            }
        </script>

        <style>
            .wordEntry {
                background-color:aliceblue;
                border-radius: 20px;
                padding-left: 10px;
                padding-bottom: 1px;
                margin-top: 20px;
            }

            h1,h3 {
                margin: 0px;
            }

            ul {
                margin:0px 0px 15px 0px;
            }
        </style>
    </head>
    <body>
        <form action="index.html" method="get" style="display: flex">
            <input type="text" name="word" style="width: 80%"/>
            <input type="submit" value="Go" style="flex-grow: 1;margin-left:3px;"/>
        </form>
        
        <div id="wordInfo"> </div>
        <h1 id="error" style="display: none"></h1>
    </body>
</html>